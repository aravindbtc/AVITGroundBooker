
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions to promote reusable and readable rules.
    function isSignedIn() {
      return request.auth != null;
    }
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    function isAdmin() {
      // Check for the admin role document OR a specific admin email for bootstrapping.
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid))
          || (isSignedIn() && request.auth.token.email == 'admin@avit.ac.in');
    }

    function isQueryingOwnData(field) {
      // Security rule to ensure a user can only query for their own documents.
      // This is crucial for list operations on collections like 'bookings'.
      return request.query.where.size() > 0 && request.query.where[0][0] == field && request.query.where[0][2] == request.auth.uid;
    }

    // Publicly readable venue information.
    // Writable only by admins.
    match /venue/{venueId} {
      allow get, list: if true;
      allow write: if isAdmin();
    }

    // Users can read/write their own profile. Admins can read any profile.
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      // Allow create only for the user themselves upon signup.
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) || isAdmin();
      // Only admins can list or delete users.
      allow list, delete: if isAdmin();
    }
    
    // Bookings can be read by their owner or any admin.
    // Admins can list all bookings. Users can ONLY list their own.
    match /bookings/{bookingId} {
      allow get: if resource.data.userId == request.auth.uid || isAdmin();
      allow list: if isAdmin() || isQueryingOwnData('userId');
      // Users create their own bookings. Ensure userId in document matches auth uid.
      allow create: if request.resource.data.userId == request.auth.uid;
      // Updates allowed by owner, admin, or backend (webhook, no auth).
      allow update: if (resource.data.userId == request.auth.uid) || isAdmin() || request.auth == null;
      allow delete: if resource.data.userId == request.auth.uid || isAdmin();
    }
    
    // Slots are publicly readable. Admins can create/delete them.
    // Users can update a slot to book it (if it's available).
    // The backend webhook (no auth) can also update slots.
    match /slots/{slotId} {
      allow get, list: if true;
      allow create, delete: if isAdmin();
      allow update: if isAdmin() || request.auth == null || (isSignedIn() && resource.data.status == 'available');
    }

    // Accessories and Manpower are publicly readable.
    // Only admins can create/delete them.
    // The backend webhook can update stock quantities.
    match /accessories/{accessoryId} {
      allow get, list: if true;
      allow create, delete: if isAdmin();
      allow update: if isAdmin() || request.auth == null;
    }

    match /manpower/{manpowerId} {
      allow get, list: if true;
      allow write: if isAdmin();
    }

    // Users can create/manage their own reviews. Admins can moderate.
    match /reviews/{reviewId} {
      allow get, list: if true;
      allow create: if request.resource.data.userId == request.auth.uid;
      allow update, delete: if resource.data.userId == request.auth.uid || isAdmin();
    }

    // Only admins can read or write to the admin roles collection.
    match /roles_admin/{userId} {
      allow read, write: if isAdmin();
    }
  }
}
