
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    function noOverlap(date, start, end) {
      // Simplified: Assume no client-side query; defer to function
      // In prod, use exists() on potential overlaps if indexed
      return request.time < timestamp.date(2026, 1, 1); // Temp broad allow; tighten with indexes
    }

    // Flexible slots: Users propose pending, admins approve
    match /venues/{venueId}/slots/{slotId} {
      // Read/list for all auth users (realtime dashboard)
      allow read, list: if request.auth != null;
      
      // Users create pending proposals (with validation)
      allow create: if request.auth != null 
        && request.resource.data.status == 'pending'
        && request.resource.data.proposerUID == request.auth.uid
        && noOverlap(request.resource.data.date, request.resource.data.start, request.end);
      
      // Users update own pending/rejected
      allow update: if request.auth != null 
        && resource.data.proposerUID == request.auth.uid
        && resource.data.status in ['pending', 'rejected'];
      
      // Admins full control
      allow update, delete: if request.auth != null 
        && request.auth.token.email == 'admin@avit.ac.in';
    }
    
    // Bookings: Auth creates, owner/admin updates
    match /bookings/{bookingId} {
      allow create: if request.auth != null && request.resource.data.userUID == request.auth.uid;
      allow read: if request.auth != null && (resource.data.userUID == request.auth.uid || request.auth.token.email == 'admin@avit.ac.in');
      allow update, delete: if request.auth != null 
        && (resource.data.userUID == request.auth.uid || request.auth.token.email == 'admin@avit.ac.in');
    }
    
    // Fallback for other collections (e.g., addons, users, venue)
    match /users/{uid} {
      allow read, write: if request.auth.uid == uid;
    }
    match /accessories/{id} {
      allow read, write: if request.auth != null;
    }
    match /venue/{id} {
      allow read, write: if request.auth != null;
    }
  }
}

    